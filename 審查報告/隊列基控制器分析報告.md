# 隊列基控制器 (Queue-Based Controller) 分析報告

**審查日期**: 2025-06-18
**審查人員**: AI助理

---

## 1. 核心邏輯解釋

- **原始碼位置**: `ai/controllers/queue_based_controller.py`
- **歷史沿革**:
    - **v0.1.19**: 首次引入基於任務優先級的權重 (`delivering_pod` > `returning_pod` > `taking_pod`)，並增加了 `min_green_time` 和 `bias_factor` 參數。
    - **v0.2.0**: 經歷了一次重大重寫，形成目前穩定、清晰的實現。
    - **v0.2.1**: 其應用範圍從單一測試路口 (15,15) 擴展至所有路口。
- **決策依據**: 這是一個基於啟發式規則的控制器，它透過一個明確定義的「優先級分數」來決定哪個方向的交通應該被放行。
- **演算法流程**:
    1. **最小綠燈時間 (`min_green_time`)**: 為防止交通燈頻繁切換，控制器會確保一旦切換方向，新方向至少會保持綠燈 `min_green_time` 個時間單位。
    2. **計算優先級分數 (`_calculate_direction_priority`)**:
        - 根據每個等待機器人的**任務狀態** (`current_state`)，給予不同的權重 (例如，`delivering_pod` 權重為 3.0，`idle` 為 0.5)。
        - 將該方向上所有機器人的權重相加，得到該方向的總優先級分數。
    3. **偏好因子 (`bias_factor`)**:
        - 在比較分數前，會將**水平方向**的總分乘以一個 `bias_factor` (預設為 1.5)。
        - 此設計基於「水平方向通常有更多機器人」的假設。
    4. **最終決策 (`get_direction`)**:
        - 在滿足最小綠燈時間的前提下，比較經過偏好因子調整後的兩個方向的優先級分數。
        - 分數較高的方向獲得通行權。

## 2. 正確性驗證

- **與日誌一致性**: **完全一致**。當前的程式碼清晰地反映了 `CHANGELOG.md` 中描述的歷次迭代，邏輯清晰、穩定。
- **邏輯缺陷評估**: 程式碼本身無誤，但其**演算法設計**存在簡化之處：
    - 固定的 `bias_factor` 是最主要的設計弱點。它硬性地給予水平方向優勢，這在垂直方向交通壓力更大的場景下，可能會導致次優決策。

## 3. 潛在改進點

- **【潛在改進點 1】**: **引入動態等待時間權重**
    - **問題**: 目前的優先級只考慮機器人的「任務」，沒有考慮它「等了多久」。這可能導致飢餓問題 (Starvation)，即一個低優先級的機器人，如果恰好遇到源源不絕的高優先級車流，可能會永遠等待下去。
    - **建議**: 在計算優先級分數時，引入機器人的等待時間。例如：`最終分數 = 任務權重 + (等待時間 * 時間因子)`。
    - **後續行動**: 這是一個非常好的改進方向，可以顯著提升控制器的公平性和效率。應在未來創建為新的代辦事項。

- **【潛在改進點 2】**: **移除或改進固定的偏好因子 (`bias_factor`)**
    - **問題**: 固定的 `bias_factor=1.5` 是基於「水平方向車多」的假設，這個假設不一定永遠成立，限制了控制器的適應性。
    - **建議**:
        - (方案A - 簡單) 將其作為一個可以在 NetLogo 界面調整的參數，方便研究不同偏好下的系統表現。
        - (方案B - 複雜) 完全移除這個偏好因子，轉而依靠一個更全面的優先級計算公式（例如上面提到的，結合等待時間的公式）。
    - **後續行動**: 這將使控制器設計更加嚴謹和通用。應在未來創建為新的代辦事項。 