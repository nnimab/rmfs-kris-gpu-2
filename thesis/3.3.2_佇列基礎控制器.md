# 3.3.2 佇列基礎控制器

佇列基礎控制器（`QueueBasedController`）是一種動態反應式控制策略，其設計目的是為了解決時間基礎控制器無法感知即時交通需求的根本性缺陷。此控制器會持續監測路口兩個方向的等待隊列，並結合機器人當前所執行任務的緊急程度，動態地計算出通行權的歸屬。相較於靜態的時間基礎控制器，佇列基礎控制器能夠更靈活地適應交通流量的變化，將通行資源優先分配給需求更迫切的方向。

### 設計原理與決策邏輯

此控制器的核心在於將兩個關鍵因素量化並結合，以進行決策：**機器人數量**與**任務優先級**。

#### 1. 任務優先級權重系統

在倉儲作業中，並非所有機器人任務都具有相同的重要性。例如，正在將貨架送往揀貨站的機器人若被延誤，會直接影響訂單的履行效率；而一台空車前往貨架區的機器人，其任務的緊急程度則相對較低。為了體現此差異，我們為不同的機器人狀態（`robot.current_state`）定義了一套優先級權重（\(W_{priority}\)）：

| 機器人狀態 (`current_state`) | 任務描述 | 優先級權重 (\(W_{priority}\)) |
| :--- | :--- | :---: |
| `delivering_pod` | 運送貨架至揀貨站 | 3.0 |
| `returning_pod` | 將貨架送回儲存區 | 2.0 |
| `taking_pod` | 前往儲存區領取貨架 | 1.0 |
| `idle` | 閒置或待命中 | 0.5 |
| `station_processing` | 於揀貨站內處理中 | 0.0 |

#### 2. 方向優先級計算

對於路口的每一個方向（水平 H 或垂直 V），控制器會計算一個加權的優先級總和（\(P_{H}\) 或 \(P_{V}\)）。此數值等於該方向上所有等待機器人（\(R_{dir}\)）各自的任務優先級權重之和。計算公式如下：

\[
P_{dir} = \sum_{i \in R_{dir}} W_{priority}(i)
\]

其中，\(W_{priority}(i)\) 代表機器人 \(i\) 當前狀態所對應的優先級權重。

此外，考慮到倉儲佈局導致的水平方向先天交通流量較大的特性，我們引入了一個偏好因子（\(\beta_{bias}\)，`bias_factor`），對水平方向的優先級總和進行加權，以給予其額外的競爭優勢。因此，最終用於比較的水平方向優先級 \(P'_{H}\) 為：

\[
P'_{H} = P_{H} \times \beta_{bias}
\]

#### 3. 決策流程

控制器的決策流程如下：
1.  **最小綠燈時間檢查**: 為避免因交通狀況快速變化而導致路口訊號頻繁切換（這會造成機器人反覆加減速，浪費能源），控制器會先檢查自上次方向切換以來，是否已達到一個最小綠燈時間（\(T_{min\_green}\)）。若否，則維持當前方向不變。
2.  **優先級比較**: 若已滿足最小綠燈時間，控制器會計算加權後的水平優先級 \(P'_{H}\) 與垂直優先級 \(P_{V}\)。
3.  **特殊情況處理**:
    - 如果任一方向沒有等待的機器人，則立即將通行權給予有機器人的另一方向。
    - 如果兩方向皆無機器人，則維持當前狀態。
4.  **最終決策**: 在一般情況下，控制器會比較 \(P'_{H}\) 和 \(P_{V}\)，將通行權分配給優先級總和較高的方向。

\[
\text{Direction} = 
\begin{cases} 
\text{Horizontal,} & \text{if } P'_{H} \geq P_{V} \\
\text{Vertical,} & \text{if } P'_{H} < P_{V}
\end{cases}
\]

透過此一機制，佇列基礎控制器能夠在兼顧穩定性（最小綠燈時間）與佈局特性（偏好因子）的同時，對即時的交通需求做出合理且有效率的反應。
